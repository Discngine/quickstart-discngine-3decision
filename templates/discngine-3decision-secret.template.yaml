---
AWSTemplateFormatVersion: 2010-09-09
Transform: AWS::SecretsManager-2020-07-23
Description: "This template deploys a Volume based on a public snapshot (qs-1snm79fe6)."
Metadata:
  LintSpellExclude:
    - Discngine
    - 3decision
Parameters:
  Subnets:
    Type: String
  DatabaseName:
    Type: String
  VpcId:
    Type: String
  DBSecurityGroup:
    Type: String
Resources:
  AdminPassword:
    Type: AWS::SecretsManager::Secret
    UpdateReplacePolicy: Retain
    DeletionPolicy: Delete
    Properties: 
      Description: String
      SecretString: '{"username": "admin", "password": "Ch4ng3m3f0rs3cur3p4ss"}'
      Name: 3dec-admin-db
  UserPassword:
    Type: AWS::SecretsManager::Secret
    UpdateReplacePolicy: Retain
    DeletionPolicy: Delete
    Properties: 
      Description: String
      SecretString: '{"username": "PD_T1_DNG_THREEDECISION", "password": "Ch4ng3m3f0rs3cur3p4ss"}'
      Name: 3dec-user-db
  ChemblPassword:
    Type: AWS::SecretsManager::Secret
    UpdateReplacePolicy: Retain
    DeletionPolicy: Delete
    Properties: 
      Description: String
      SecretString: '{"username": "CHEMBL_29", "password": "Ch4ng3m3f0rs3cur3p4ss"}'
      Name: 3dec-chembl-db
  LambdaSecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupDescription: "Creates lambda security group to acces database"
      VpcId: !Ref VpcId
      SecurityGroupIngress:
      - SourceSecurityGroupId: !Ref DBSecurityGroup
        IpProtocol: TCP
        FromPort: 1521
        ToPort: 1521
      SecurityGroupEgress:
      - CidrIp: 0.0.0.0/0
        IpProtocol: "-1"
  AllowLambdaAccess:
    Type: AWS::EC2::SecurityGroupIngress
    Properties:
      FromPort: 1521
      ToPort: 1521
      IpProtocol: TCP
      SourceSecurityGroupId: !Ref LambdaSecurityGroup
      GroupId: !Ref DBSecurityGroup
  SecretRDSInstanceAttachment:
    Type: AWS::SecretsManager::SecretTargetAttachment
    Properties:
      SecretId: !Ref AdminPassword
      TargetId: !Ref DatabaseName
      TargetType: AWS::RDS::DBInstance
  AdminRotate:
    Type: AWS::SecretsManager::RotationSchedule
    DependsOn: SecretRDSInstanceAttachment
    UpdateReplacePolicy: Retain
    DeletionPolicy: Delete
    Metadata: { cfn-lint: { config: { ignore_checks: [ E3002 ] } } }
    Properties: 
      HostedRotationLambda: 
        ExcludeCharacters: "' ! \" # $ % & ( ) * + , - . / : ; < = > ? @ [ \\ ] ^  ` { | } ~"
        RotationLambdaName: SecretsManagerRotation
        RotationType: OracleSingleUser
        VpcSubnetIds: !Ref Subnets
        VpcSecurityGroupIds: !Ref LambdaSecurityGroup
      RotateImmediatelyOnUpdate: true
      RotationRules:
        AutomaticallyAfterDays: 30
      SecretId: !Ref AdminPassword
  UserSecretRDSInstanceAttachment:
    Type: AWS::SecretsManager::SecretTargetAttachment
    Properties:
      SecretId: !Ref UserPassword
      TargetId: !Ref DatabaseName
      TargetType: AWS::RDS::DBInstance
  UserRotate:
    Type: AWS::SecretsManager::RotationSchedule
    DependsOn: AdminRotate 
    UpdateReplacePolicy: Retain
    DeletionPolicy: Delete
    Metadata: { cfn-lint: { config: { ignore_checks: [ E3002 ] } } }
    Properties:
      RotationLambdaARN: !Sub 'arn:${AWS::Partition}:lambda:${AWS::Region}:${AWS::AccountId}:function:SecretsManagerRotation'
      RotateImmediatelyOnUpdate: true
      RotationRules:
        AutomaticallyAfterDays: 30
      SecretId: !Ref UserPassword
  ChemblSecretRDSInstanceAttachment:
    Type: AWS::SecretsManager::SecretTargetAttachment
    Properties:
      SecretId: !Ref ChemblPassword
      TargetId: !Ref DatabaseName
      TargetType: AWS::RDS::DBInstance
  ChemblRotate:
    Type: AWS::SecretsManager::RotationSchedule
    DependsOn: AdminRotate
    UpdateReplacePolicy: Retain
    DeletionPolicy: Delete
    Metadata: { cfn-lint: { config: { ignore_checks: [ E3002 ] } } }
    Properties: 
      RotationLambdaARN: !Sub 'arn:${AWS::Partition}:lambda:${AWS::Region}:${AWS::AccountId}:function:SecretsManagerRotation'
      RotateImmediatelyOnUpdate: true
      RotationRules:
        AutomaticallyAfterDays: 30
      SecretId: !Ref ChemblPassword
  User:
    Type: AWS::IAM::User
    Properties: 
      UserName: 3decision
  UserPolicy:
    Type: AWS::IAM::Policy
    Properties:
      PolicyName: 3decisionPolicy
      Users:
        - !Ref User
      PolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Action:
              - secretsmanager:GetResourcePolicy
              - secretsmanager:GetSecretValue
              - secretsmanager:DescribeSecret
              - secretsmanager:ListSecretVersionIds
            Resource: 
              - !Ref AdminPassword
              - !Ref UserPassword
              - !Ref ChemblPassword
  AccessKey:
    Type: AWS::IAM::AccessKey
    DependsOn: User
    Properties: 
      Status: Active
      UserName: 3decision
Outputs:
  AccessKey:
    Value: !Ref AccessKey
  SecretAccessKey:
    Value: !GetAtt AccessKey.SecretAccessKey