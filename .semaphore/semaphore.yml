version: v1.0
name: 3decision Quickstart CI
agent:
  machine:
    type: e1-standard-2
    os_image: ubuntu2004
global_job_config:
  # Connect secret to all jobs in the pipeline
  secrets:
    - name: 3dec-quickstart
blocks:
  - name: Cloudformation linting
    run:
      when: "pull_request =~ '.*'"
    task:
      jobs:
        - name: linting
          commands:
            - checkout
            - export PATH=$PATH:~/.local/bin
            - cd ~/
            - git clone https://github.com/aws-quickstart/qs-cfn-lint-rules.git
            - cd qs-cfn-lint-rules
            - sudo apt update
            - sudo apt install python3.8-venv -y
            - python3 -m venv .
            - . ./bin/activate
            - pip install -e .
            - cfn-lint ~/quickstart-discngine-3decision/templates/* -a ~/qs-cfn-lint-rules/qs_cfn_lint_rules/ -i E0000 E1010 E1019 E3001 W9001 W9002 W9003 W9004 W9005 W9006 E9101
  - name: Test templates upload
  # Run on commit on non main branch
    run:
      when: "branch != 'main' AND pull_request !~ '.*'"
    task:
      jobs:
        - name: templates upload
          commands:
            - checkout
#            - export AWS_ACCESS_KEY_ID=${ACCESS_KEY}
#            - export AWS_SECRET_ACCESS_KEY=${SECRET_ACCESS_KEY}
            - export ROLE_ARN="arn:aws:iam::751149478800:role/3dec-Quickstart-CD"
            - export SESSION_NAME="semaphore-job-${SEMAPHORE_JOB_ID}"
            - export CREDENTIALS=$(aws sts assume-role-with-web-identity --role-arn $ROLE_ARN --role-session-name $SESSION_NAME --web-identity-token $SEMAPHORE_OIDC_TOKEN)
            - echo $CREDENTIALS
            - echo $SEMAPHORE_OIDC_TOKEN
            - export AWS_ACCESS_KEY_ID=$(echo $CREDENTIALS | jq -r '.Credentials.AccessKeyId')
            - export AWS_SESSION_TOKEN=$(echo $CREDENTIALS | jq -r '.Credentials.SessionToken')
            - export AWS_SECRET_ACCESS_KEY=$(echo $CREDENTIALS | jq -r '.Credentials.SecretAccessKey')
            - sh ~/quickstart-discngine-3decision/.semaphore/bin/rewrite_qss.sh "-test"
            - aws s3 sync ~/quickstart-discngine-3decision/templates s3://3decision-eu-central-1/quickstart-discngine-3decision-test/templates
  - name: Templates upload
  # Run on commit on main branch
    run:
      when: "branch = 'main' AND pull_request !~ '.*'"
    task:
      jobs:
        - name: templates upload
          commands:
            - checkout
            - export AWS_ACCESS_KEY_ID=${ACCESS_KEY}
            - export AWS_SECRET_ACCESS_KEY=${SECRET_ACCESS_KEY}
            - sh ~/quickstart-discngine-3decision/.semaphore/bin/rewrite_qss.sh
            - aws s3 sync ~/quickstart-discngine-3decision/templates s3://3decision-eu-central-1/quickstart-discngine-3decision/templates